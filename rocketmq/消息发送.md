# 消息发送

## 队列选择

最基本的选择，一个是随机，一个是按照hash（默认），但是在默认的producer中，添加了大量的容错机制。

- 没有开始故障延迟机制。

默认重试3次。第一次先随机选择一个队列，发送失败进行重试，此时会记录上次发送失败的broker。然后找下一个不是失败broker的队列，如果没有找到，就用最基本的策略。

- 启动故障延迟机制。

重试默认也是3次。首先也是随机选择一个，发送一次，失败重试。此时会找容错机制中可用的broker的队列。如果还没有找到，从全部faultitem中，选择一个差不多的。这里的差不多的实现方式是，faultitem按照好坏排序，然后取前面一半中的随机一个，同时也类似前面的随机，当失败重试后，会将随机数+1，表示找下一个。

faultitem表示有问题的broker，当发送到某个broker时，无论成功与否，都会将broker放入faultitem中。成功时，潜在时间是从开始发送到结束发送的时间差，然后根据这个时间，计算出对应的不可用时间；失败时，时间是30s。

latencyMax = {50L, 100L, 550L, 1000L, 2000L, 3000L, 15000L};
notAvailableDuration = {0L, 0L, 30000L, 60000L, 120000L, 180000L, 600000L};

## 发送消息

主要是组装消息发送需要的格式（此时会设置一个uniquekey），然后调用client发送。其他没看到特别需要关注的。
